<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynthora Playable</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ff9900;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            touch-action: none;
            user-select: none;
        }
        h1 { border-bottom: 2px solid #ff9900; padding-bottom: 0.5rem; margin-top: 0; }
        
        .panel {
            background: #222;
            border: 1px solid #444;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            display: grid;
            gap: 1.5rem;
        }
        
        .section-title {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .control { }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; }
        
        input[type=range] { width: 100%; accent-color: #ff9900; cursor: pointer; }
        
        .btn-group { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            flex: 1;
        }
        button.active {
            background: #ff9900;
            color: #000;
            border-color: #ff9900;
        }
        
        .fx-row { display: flex; gap: 10px; }
        
        /* KEYBOARD STYLES */
        .keyboard {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 10px;
            height: 120px;
        }
        .key {
            background: #fff;
            border-radius: 0 0 4px 4px;
            width: 40px;
            position: relative;
            cursor: pointer;
        }
        .key.black {
            background: #000;
            color: #fff;
            height: 70px;
            width: 30px;
            margin-left: -17px;
            margin-right: -17px;
            z-index: 2;
            border: 1px solid #333;
        }
        .key.white {
            height: 100%;
            z-index: 1;
            border: 1px solid #ccc;
        }
        .key.active {
            background: #ff9900 !important;
        }
        .key span {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            color: #888;
            font-size: 0.7rem;
            pointer-events: none;
        }
        
        #status {
            margin-top: 1rem;
            color: #666;
            font-size: 0.8rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ZYNTHORA PLAYABLE</h1>
    
    <div class="panel">
        
        <!-- OSCILLATOR -->
        <div>
            <div class="section-title">SOURCE</div>
            <div class="control">
                <div class="btn-group" id="waveforms">
                    <button onclick="setWave('sine', this)">SIN</button>
                    <button onclick="setWave('triangle', this)">TRI</button>
                    <button onclick="setWave('saw', this)" class="active">SAW</button>
                    <button onclick="setWave('square', this)">SQR</button>
                </div>
            </div>
            <div class="control" style="margin-top: 10px;">
                <label>DRIVE: <span id="driveVal">0.0</span></label>
                <input type="range" id="drive" min="0" max="1" value="0.0" step="0.01">
            </div>
        </div>

        <!-- FILTER -->
        <div>
            <div class="section-title">FILTER (MOOG)</div>
            <div class="control">
                <label>CUTOFF: <span id="cutoffVal">20000</span> Hz</label>
                <input type="range" id="cutoff" min="100" max="10000" value="10000" step="10">
            </div>
            <div class="control">
                <label>RESONANCE: <span id="resVal">0.0</span></label>
                <input type="range" id="res" min="0" max="0.95" value="0.0" step="0.01">
            </div>
        </div>

        <!-- EFFECTS -->
        <div>
            <div class="section-title">EFFECTS</div>
            <div class="fx-row">
                <button id="chorusBtn" onclick="toggleChorus()">CHORUS</button>
                <button id="delayBtn" onclick="toggleDelay()">DELAY</button>
                <button id="verbBtn" onclick="toggleReverb()" class="active">REVERB</button>
            </div>
        </div>
        
        <!-- KEYBOARD -->
        <div>
            <div class="section-title">KEYBOARD (A-K = White Keys)</div>
            <div class="keyboard" id="kb">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <div id="status">Connecting...</div>
    </div>

    <script>
        const els = {
            drive: document.getElementById('drive'),
            cutoff: document.getElementById('cutoff'),
            res: document.getElementById('res'),
            driveVal: document.getElementById('driveVal'),
            cutoffVal: document.getElementById('cutoffVal'), // FIXED
            resVal: document.getElementById('resVal'),
            status: document.getElementById('status')
        };
        
        let socket;
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/websocket';
            socket = new WebSocket(wsUrl);
            socket.onopen = () => {
                els.status.textContent = "ONLINE";
                els.status.style.color = "#ff9900";
            };
            socket.onclose = () => setTimeout(connect, 2000);
        }

        function send(cmd, val) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(cmd + ":" + val);
            }
        }

        const bind = (id, cmd) => {
            const el = els[id];
            if (!el) {
                console.error("Missing element for bind:", id);
                return;
            }
            el.addEventListener('input', (e) => {
                const valEl = els[id + 'Val'];
                if (valEl) valEl.textContent = e.target.value;
                send(cmd, e.target.value);
            });
        };
        bind('drive', 'drive');
        bind('cutoff', 'cutoff');
        bind('res', 'res');

        window.setWave = (type, btn) => {
            document.querySelectorAll('#waveforms button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            send('wave', type);
        };

        const toggleFx = (btnId, cmd, startState) => {
            let state = startState;
            const btn = document.getElementById(btnId);
            const update = () => {
                btn.classList.toggle('active', state);
                send(cmd, state ? 1 : 0);
            };
            // update(); // Set initial
            return () => { state = !state; update(); };
        };

        window.toggleReverb = toggleFx('verbBtn', 'reverb', true);
        window.toggleChorus = toggleFx('chorusBtn', 'chorus', false);
        window.toggleDelay  = toggleFx('delayBtn', 'delay', false);

        // --- KEYBOARD LOGIC ---
        const keys = [
            { note: 60, key: 'a', type: 'white' }, // C4
            { note: 61, key: 'w', type: 'black' }, // C#
            { note: 62, key: 's', type: 'white' }, // D
            { note: 63, key: 'e', type: 'black' }, // D#
            { note: 64, key: 'd', type: 'white' }, // E
            { note: 65, key: 'f', type: 'white' }, // F
            { note: 66, key: 't', type: 'black' }, // F#
            { note: 67, key: 'g', type: 'white' }, // G
            { note: 68, key: 'y', type: 'black' }, // G#
            { note: 69, key: 'h', type: 'white' }, // A
            { note: 70, key: 'u', type: 'black' }, // A#
            { note: 71, key: 'j', type: 'white' }, // B
            { note: 72, key: 'k', type: 'white' }, // C5
        ];

        const kbEl = document.getElementById('kb');
        keys.forEach(k => {
            const div = document.createElement('div');
            div.className = `key ${k.type}`;
            div.id = `key-${k.key}`;
            div.innerHTML = `<span>${k.key.toUpperCase()}</span>`;
            
            // Mouse/Touch Events
            const down = (e) => { e.preventDefault(); playNote(k.note, div); };
            const up = (e) => { e.preventDefault(); stopNote(div); };
            
            div.addEventListener('mousedown', down);
            div.addEventListener('mouseup', up);
            div.addEventListener('mouseleave', up);
            div.addEventListener('touchstart', down);
            div.addEventListener('touchend', up);
            
            kbEl.appendChild(div);
        });

        let activeKey = null;

        function playNote(note, el) {
            if (activeKey === note) return; // Ignore repeats
            activeKey = note;
            if(el) el.classList.add('active');
            send('note', note);
            send('gate', 1);
        }

        function stopNote(el) {
            if(el) el.classList.remove('active');
            send('gate', 0);
            activeKey = null;
        }

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                playNote(k.note, document.getElementById(`key-${k.key}`));
            }
        });

        document.addEventListener('keyup', (e) => {
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                stopNote(document.getElementById(`key-${k.key}`));
            }
        });

        connect();
    </script>
</body>
</html>

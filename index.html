<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynthora FM</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ff9900;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            touch-action: none;
            user-select: none;
        }

        h1 {
            border-bottom: 2px solid #ff9900;
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        .panel {
            background: #222;
            border: 1px solid #444;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            display: grid;
            gap: 1.5rem;
        }

        .section-title {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .control {}

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        input[type=range] {
            width: 100%;
            accent-color: #ff9900;
            cursor: pointer;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            flex: 1;
        }

        button.active {
            background: #ff9900;
            color: #000;
            border-color: #ff9900;
        }

        .fx-row {
            display: flex;
            gap: 10px;
        }

        /* KEYBOARD STYLES */
        .keyboard {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 10px;
            height: 120px;
        }

        .key {
            background: #fff;
            border-radius: 0 0 4px 4px;
            width: 40px;
            position: relative;
            cursor: pointer;
        }

        .key.black {
            background: #000;
            color: #fff;
            height: 70px;
            width: 30px;
            margin-left: -17px;
            margin-right: -17px;
            z-index: 2;
            border: 1px solid #333;
        }

        .key.white {
            height: 100%;
            z-index: 1;
            border: 1px solid #ccc;
        }

        .key.active {
            background: #ff9900 !important;
        }

        .key span {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            color: #888;
            font-size: 0.7rem;
            pointer-events: none;
        }

        #status {
            margin-top: 1rem;
            color: #666;
            font-size: 0.8rem;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <h1>ZYNTHORA FM</h1>

    <div class="panel">

        <!-- OSCILLATOR -->
        <div>
            <div class="section-title">SOURCE</div>
            <div class="control">
                <div class="btn-group" id="waveforms">
                    <button onclick="setWave('sine', this)" class="active">SIN</button>
                    <button onclick="setWave('triangle', this)">TRI</button>
                    <button onclick="setWave('saw', this)">SAW</button>
                    <button onclick="setWave('square', this)">SQR</button>
                    <button onclick="setWave('fm', this)">FM</button>
                    <button onclick="setWave('wavetable', this)">WT</button>
                    <button onclick="setWave('braids', this)">BRAIDS</button>
                    <button onclick="setWave('logue', this)">LOGUE</button>
                    <button onclick="setWave('plaits', this)">PLAITS</button>
                </div>
            </div>

            <div
                style="display: flex; gap: 10px; margin-top: 10px; align-items: center; border-top: 1px solid #333; padding-top: 10px;">
                <label style="margin:0;"><input type="checkbox" id="fm_custom_on" onchange="toggleCustomFM(this)">
                    CUSTOM FM</label>
                <select id="fm_mod_wave" onchange="setModWave(this)" disabled
                    style="background:#333; color:#fff; border:1px solid #666; padding: 5px;">
                    <option value="0">SIN</option>
                    <option value="1">TRI</option>
                    <option value="100">FM</option>
                    <option value="101">Wavetable</option>
                    <option value="102">Logue Saw (Paraphonic)</option>
                    <option value="2">SAW</option>
                    <option value="3">SQR</option>
                </select>
            </div>

            <!-- Braids CONTROLS -->
            <div id="braids_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px;">
                <div class="control">
                    <label>EDIT (MODEL): <span id="braids_modelVal">0</span></label>
                    <input type="range" id="braids_model" min="0" max="47" value="0" step="1">
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>FINE: <span id="braids_fineVal">0.00</span></label>
                        <input type="range" id="braids_fine" min="-1.0" max="1.0" value="0.0" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>COARSE: <span id="braids_coarseVal">0.00</span></label>
                        <input type="range" id="braids_coarse" min="-24" max="24" value="0" step="1">
                    </div>
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>FM: <span id="braids_fmVal">0.00</span></label>
                        <input type="range" id="braids_fm" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>TIMBRE: <span id="braids_timbreVal">0.00</span></label>
                        <input type="range" id="braids_timbre" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>MOD: <span id="braids_modulationVal">0.00</span></label>
                        <input type="range" id="braids_modulation" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>COLOR: <span id="braids_colorVal">0.00</span></label>
                        <input type="range" id="braids_color" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- PLAITS CONTROLS -->
            <div id="plaits_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px;">
                <div class="control-group">
                    <h3>Master Effects</h3>
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="studio_enable"
                                onchange="send('studio_enable', this.checked ? 1 : 0)">
                            Enable Master FX
                        </label>
                    </div>
                    <div class="control-group">
                        <label>Console Drive</label>
                        <input type="range" id="console_drive" min="0" max="1" step="0.01" value="0.5"
                            oninput="send('console_drive', this.value)">
                    </div>
                    <div class="control-group">
                        <label>Mackity Drive</label>
                        <input type="range" id="mackity_drive" min="0" max="1" step="0.01" value="0.8"
                            oninput="send('mackity_drive', this.value)">
                    </div>
                    <div class="control-group">
                        <label>Pressure Thresh</label>
                        <input type="range" id="pressure_thresh" min="0" max="1" step="0.01" value="0.5"
                            oninput="send('pressure_thresh', this.value)">
                    </div>
                    <!-- Existing Effects -->
                </div>

                <div class="control">
                    <label>MODEL: <span id="plaits_modelVal" class="hidden">0</span></label>
                    <select id="plaits_model"
                        style="width: 100%; padding: 5px; background: #333; color: #fff; border: 1px solid #666;">
                        <option value="0">Analog VCF</option>
                        <option value="1">Phase Distortion</option>
                        <option value="2">Six Op FM (1)</option>
                        <option value="3">Six Op FM (2)</option>
                        <option value="4">Six Op FM (3)</option>
                        <option value="5">Wave Terrain</option>
                        <option value="6">String Machine</option>
                        <option value="7">Chiptune</option>
                        <option value="8">Virtual Analog</option>
                        <option value="9">Waveshaping</option>
                        <option value="10">FM</option>
                        <option value="11">Grain</option>
                        <option value="12">Additive</option>
                        <option value="13">Wavetable</option>
                        <option value="14">Chord</option>
                        <option value="15">Speech</option>
                        <option value="16">Swarm</option>
                        <option value="17">Noise</option>
                        <option value="18">Particle</option>
                        <option value="19">String</option>
                        <option value="20">Modal</option>
                        <option value="21">Bass Drum</option>
                        <option value="22">Snare Drum</option>
                        <option value="23">Hi Hat</option>
                    </select>
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>HARMONICS: <span id="plaits_harmonicsVal">0.50</span></label>
                        <input type="range" id="plaits_harmonics" min="0.0" max="1.0" value="0.5" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>TIMBRE: <span id="plaits_timbreVal">0.50</span></label>
                        <input type="range" id="plaits_timbre" min="0.0" max="1.0" value="0.5" step="0.01">
                    </div>
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>MORPH: <span id="plaits_morphVal">0.50</span></label>
                        <input type="range" id="plaits_morph" min="0.0" max="1.0" value="0.5" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>DECAY: <span id="plaits_decayVal">0.50</span></label>
                        <input type="range" id="plaits_decay" min="0.0" max="1.0" value="0.5" step="0.01">
                    </div>
                </div>
                <div class="fx-row">
                    <div class="control" style="flex:1">
                        <label>FM (LFO): <span id="plaits_fmVal">0.00</span></label>
                        <input type="range" id="plaits_fm" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                    <div class="control" style="flex:1">
                        <label>MOD (TIMBRE): <span id="plaits_modVal">0.00</span></label>
                        <input type="range" id="plaits_mod" min="0.0" max="1.0" value="0.0" step="0.01">
                    </div>
                </div>
            </div>

            <!-- WAVETABLE CONTROLS -->
            <div id="wt_controls" class="hidden" style="margin-top: 10px;">
                <div class="control">
                    <label>WAVE MORPH: <span id="wt_indexVal">0.00</span></label>
                    <input type="range" id="wt_index" min="0" max="63" value="0" step="0.01">
                </div>
            </div>

            <!-- LOGUE CONTROLS -->
            <div id="logue_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px;">
                <div class="control">
                    <label>DETUNE: <span id="logue_detuneVal">0.00</span></label>
                    <input type="range" id="logue_detune" min="0" max="1" value="0" step="0.01">
                </div>
                <div class="control">
                    <label>OCTAVE: <span id="logue_octVal">0</span></label>
                    <input type="range" id="logue_oct" min="-3" max="3" value="0" step="1">
                </div>
            </div>

            <div id="fm_controls" class="hidden" style="display: flex; gap: 10px; margin-top: 10px;">
                <div class="control" style="flex: 1;">
                    <label>FM RATIO: <span id="fm_ratioVal">2.0</span></label>
                    <input type="range" id="fm_ratio" min="0.1" max="10.0" value="2.0" step="0.1">
                </div>
                <div class="control" style="flex: 1;">
                    <label>FM INDEX: <span id="fm_indexVal">1.0</span></label>
                    <input type="range" id="fm_index" min="0.0" max="5.0" value="1.0" step="0.1">
                </div>
            </div>

            <div class="control" style="margin-top: 10px;">
                <label>DRIVE: <span id="driveVal">0.0</span></label>
                <input type="range" id="drive" min="0" max="1" value="0.0" step="0.01">
            </div>
        </div>

        <!-- FILTER -->
        <div>
            <div class="section-title">FILTER (MOOG)</div>
            <div class="control">
                <label>CUTOFF: <span id="cutoffVal">20000</span> Hz</label>
                <input type="range" id="cutoff" min="100" max="10000" value="20000" step="10">
            </div>
            <div class="control">
                <label>RESONANCE: <span id="resVal">0.0</span></label>
                <input type="range" id="res" min="0" max="0.95" value="0.0" step="0.01">
            </div>
        </div>

        <!-- EFFECTS -->
        <div>
            <div class="section-title">EFFECTS</div>
            <div class="fx-row">
                <button id="chorusBtn" onclick="toggleChorus()">CHORUS</button>
                <button id="delayBtn" onclick="toggleDelay()">DELAY</button>
                <button id="verbBtn" onclick="toggleReverb()">REVERB</button>
            </div>

            <!-- DELAY CONTROLS -->
            <div id="delay_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>DELAY TIME: <span id="dtimeVal">0.3</span>s</label>
                    <input type="range" id="dtime" min="0.05" max="0.9" value="0.3" step="0.01">
                </div>
                <div class="control">
                    <label>DELAY FEEDBACK: <span id="dfeedVal">0.4</span></label>
                    <input type="range" id="dfeed" min="0" max="0.9" value="0.4" step="0.01">
                </div>
            </div>

            <!-- CHORUS CONTROLS -->
            <div id="chorus_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>CHORUS RATE: <span id="crateVal">0.3</span>Hz</label>
                    <input type="range" id="crate" min="0.1" max="5.0" value="0.3" step="0.1">
                </div>
                <div class="control">
                    <label>CHORUS DEPTH: <span id="cdepthVal">0.8</span></label>
                    <input type="range" id="cdepth" min="0" max="1.0" value="0.8" step="0.01">
                </div>
            </div>

            <!-- REVERB CONTROLS -->
            <div id="reverb_controls" class="hidden"
                style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>REVERB DECAY: <span id="rtimeVal">0.85</span></label>
                    <input type="range" id="rtime" min="0.3" max="0.99" value="0.85" step="0.01">
                </div>
                <div class="control">
                    <label>REVERB TONE: <span id="rtoneVal">10000</span>Hz</label>
                    <input type="range" id="rtone" min="1000" max="18000" value="10000" step="100">
                </div>
            </div>
        </div>

        <!-- STUDIO EFFECTS (AIRWINDOWS) -->
        <div style="border-top: 1px solid #444; padding-top: 10px; margin-top: 10px;">
            <div class="panel-header">
                <span>STUDIO</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="studio_enable" checked onchange="syncState()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="control">
                <label>GALACTIC MIX: <span id="gmixVal">0.00</span></label>
                <input type="range" id="gmix" min="0" max="1" value="0.0" step="0.01">
            </div>
            <div class="fx-row">
                <div class="control" style="flex:1">
                    <label>SIZE: <span id="gsizeVal">0.50</span></label>
                    <input type="range" id="gsize" min="0" max="1" value="0.5" step="0.01">
                </div>
                <div class="control" style="flex:1">
                    <label>DETUNE: <span id="gdetuneVal">0.50</span></label>
                    <input type="range" id="gdetune" min="0" max="1" value="0.5" step="0.01">
                </div>
            </div>
            <div class="fx-row">
                <div class="control" style="flex:1">
                    <label>BRIGHT: <span id="gbrightVal">0.50</span></label>
                    <input type="range" id="gbright" min="0" max="1" value="0.5" step="0.01">
                </div>
                <div class="control" style="flex:1">
                    <label>CONSOLE DRV: <span id="cdriveVal">0.00</span></label>
                    <input type="range" id="cdrive" min="0" max="1" value="0.0" step="0.01">
                </div>
            </div>
            <div class="fx-row">
                <div class="control" style="flex:1">
                    <label>TOPE DRIVE: <span id="tdriveVal">0.00</span></label>
                    <input type="range" id="tdrive" min="0" max="1" value="0.0" step="0.01">
                </div>
                <div class="control" style="flex:1">
                    <label>TOPE FUZZ: <span id="tfuzzVal">0.00</span></label>
                    <input type="range" id="tfuzz" min="0" max="1" value="0.0" step="0.01">
                </div>
            </div>
        </div>

        <!-- MASTER -->
        <div class="control" style="border-top: 1px solid #444; padding-top: 15px;">
            <label>MASTER VOL: <span id="ampVal">0.5</span></label>
            <input type="range" id="amp" min="0" max="1" value="0.5" step="0.01">
        </div>

        <!-- KEYBOARD -->
        <div>
            <div class="section-title">KEYBOARD (A-K = White Keys)</div>
            <div class="keyboard" id="kb">
                <!-- Generated by JS -->
            </div>
        </div>

        <div id="status">Connecting...</div>
    </div>

    <script>
        const els = {
            drive: document.getElementById('drive'),
            cutoff: document.getElementById('cutoff'),
            res: document.getElementById('res'),

            dtime: document.getElementById('dtime'),
            dfeed: document.getElementById('dfeed'),
            crate: document.getElementById('crate'),
            cdepth: document.getElementById('cdepth'),
            rtime: document.getElementById('rtime'),
            rtone: document.getElementById('rtone'),

            amp: document.getElementById('amp'),
            fm_ratio: document.getElementById('fm_ratio'),
            fm_ratio: document.getElementById('fm_ratio'),
            fm_index: document.getElementById('fm_index'),
            wt_index: document.getElementById('wt_index'),
            logue_detune: document.getElementById('logue_detune'),
            logue_oct: document.getElementById('logue_oct'),

            // BRAIDS
            braids_controls: document.getElementById('braids_controls'),
            braids_model: document.getElementById('braids_model'),
            braids_fine: document.getElementById('braids_fine'),
            braids_coarse: document.getElementById('braids_coarse'),
            braids_fm: document.getElementById('braids_fm'),
            braids_timbre: document.getElementById('braids_timbre'),
            braids_modulation: document.getElementById('braids_modulation'),
            braids_color: document.getElementById('braids_color'),

            braids_modelVal: document.getElementById('braids_modelVal'),
            braids_fineVal: document.getElementById('braids_fineVal'),
            braids_coarseVal: document.getElementById('braids_coarseVal'),
            braids_fmVal: document.getElementById('braids_fmVal'),
            braids_timbreVal: document.getElementById('braids_timbreVal'),
            braids_modulationVal: document.getElementById('braids_modulationVal'),
            braids_colorVal: document.getElementById('braids_colorVal'),

            // PLAITS
            plaits_controls: document.getElementById('plaits_controls'),
            plaits_model: document.getElementById('plaits_model'),
            plaits_harmonics: document.getElementById('plaits_harmonics'),
            plaits_timbre: document.getElementById('plaits_timbre'),
            plaits_morph: document.getElementById('plaits_morph'),
            plaits_decay: document.getElementById('plaits_decay'),
            plaits_fm: document.getElementById('plaits_fm'),
            plaits_mod: document.getElementById('plaits_mod'),

            plaits_modelVal: document.getElementById('plaits_modelVal'),
            plaits_harmonicsVal: document.getElementById('plaits_harmonicsVal'),
            plaits_timbreVal: document.getElementById('plaits_timbreVal'),
            plaits_morphVal: document.getElementById('plaits_morphVal'),
            plaits_decayVal: document.getElementById('plaits_decayVal'),
            plaits_fmVal: document.getElementById('plaits_fmVal'),
            plaits_modVal: document.getElementById('plaits_modVal'),

            // Studio
            studio_enable: document.getElementById('studio_enable'),
            gmix: document.getElementById('gmix'),
            gsize: document.getElementById('gsize'),
            gdetune: document.getElementById('gdetune'),
            gbright: document.getElementById('gbright'),
            cdrive: document.getElementById('cdrive'),
            tdrive: document.getElementById('tdrive'),
            tfuzz: document.getElementById('tfuzz'),

            gmixVal: document.getElementById('gmixVal'),
            gsizeVal: document.getElementById('gsizeVal'),
            gdetuneVal: document.getElementById('gdetuneVal'),
            gbrightVal: document.getElementById('gbrightVal'),
            cdriveVal: document.getElementById('cdriveVal'),
            tdriveVal: document.getElementById('tdriveVal'),
            tfuzzVal: document.getElementById('tfuzzVal'),


            driveVal: document.getElementById('driveVal'),
            cutoffVal: document.getElementById('cutoffVal'),
            resVal: document.getElementById('resVal'),

            // ... (keeping existing refs)
            dtime: document.getElementById('dtime'),
            dfeed: document.getElementById('dfeed'),
            crate: document.getElementById('crate'),
            cdepth: document.getElementById('cdepth'),
            rtime: document.getElementById('rtime'),
            rtone: document.getElementById('rtone'),

            amp: document.getElementById('amp'),
            fm_ratio: document.getElementById('fm_ratio'),
            fm_index: document.getElementById('fm_index'),
            wt_index: document.getElementById('wt_index'),

            dtimeVal: document.getElementById('dtimeVal'),
            dfeedVal: document.getElementById('dfeedVal'),
            crateVal: document.getElementById('crateVal'),
            cdepthVal: document.getElementById('cdepthVal'),
            rtimeVal: document.getElementById('rtimeVal'),
            rtoneVal: document.getElementById('rtoneVal'),

            ampVal: document.getElementById('ampVal'),
            fm_ratioVal: document.getElementById('fm_ratioVal'),
            fm_indexVal: document.getElementById('fm_indexVal'),
            wt_indexVal: document.getElementById('wt_indexVal'),
            logue_detuneVal: document.getElementById('logue_detuneVal'),
            logue_octVal: document.getElementById('logue_octVal'),


            status: document.getElementById('status'),

            fm_controls: document.getElementById('fm_controls'),
            fm_custom_on: document.getElementById('fm_custom_on'),
            fm_mod_wave: document.getElementById('fm_mod_wave'),
            wt_controls: document.getElementById('wt_controls'),
            logue_controls: document.getElementById('logue_controls'),


            // Studio / Airwindows
            studio_enable: document.getElementById('studio_enable'),
            console_drive: document.getElementById('console_drive'),
            mackity_drive: document.getElementById('mackity_drive'),
            pressure_thresh: document.getElementById('pressure_thresh'),

            // FX Panels
            delay_controls: document.getElementById('delay_controls'),
            chorus_controls: document.getElementById('chorus_controls'),
            reverb_controls: document.getElementById('reverb_controls')
        };

        let socket;
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/websocket';
            socket = new WebSocket(wsUrl);
            socket.onopen = () => {
                els.status.textContent = "ONLINE";
                els.status.style.color = "#ff9900";
                syncState(); // Sync UI to DSP
            };
            socket.onclose = () => setTimeout(connect, 2000);
        }

        // Send all current UI values to the DSP
        function syncState() {
            console.log("Syncing state...");
            // Sliders
            send('drive', els.drive.value);
            send('cutoff', els.cutoff.value);
            send('res', els.res.value);

            send('dtime', els.dtime.value);
            send('dfeed', els.dfeed.value);
            send('chorus_rate', els.crate.value);
            send('chorus_depth', els.cdepth.value);
            send('reverb_time', els.rtime.value);
            send('reverb_tone', els.rtone.value);

            send('amp', els.amp.value);
            send('fm_ratio', els.fm_ratio.value);
            send('fm_index', els.fm_index.value);
            send('wt_index', els.wt_index.value);
            send('logue_detune', els.logue_detune.value);
            send('logue_oct', els.logue_oct.value);

            // Braids Sync
            send('braids_model', els.braids_model.value);
            send('braids_fine', els.braids_fine.value);
            send('braids_coarse', els.braids_coarse.value);
            send('braids_fm', els.braids_fm.value);
            send('braids_timbre', els.braids_timbre.value);
            send('braids_modulation', els.braids_modulation.value);
            send('braids_color', els.braids_color.value);

            // Plaits Sync
            send('plaits_model', els.plaits_model.value);
            send('plaits_harmonics', els.plaits_harmonics.value);
            send('plaits_timbre', els.plaits_timbre.value);
            send('plaits_morph', els.plaits_morph.value);
            send('plaits_decay', els.plaits_decay.value);
            send('plaits_fm', els.plaits_fm.value);
            send('plaits_mod', els.plaits_mod.value);

            // Studio Sync
            send('studio_enable', els.studio_enable.checked ? 1 : 0);
            send('galactic_mix', els.gmix.value);
            send('galactic_size', els.gsize.value);
            send('galactic_detune', els.gdetune.value);
            send('galactic_bright', els.gbright.value);
            send('console_drive', els.console_drive.value);
            send('mackity_drive', els.mackity_drive.value);
            send('pressure_thresh', els.pressure_thresh.value);
            send('tope_drive', els.tdrive.value);
            send('tope_fuzz', els.tfuzz.value);


            // Toggles
            updateFxState();

            // Waveform
            send('wave', currentWave);

            // Custom FM
            send('fm_enable', els.fm_custom_on.checked ? 1 : 0);
            send('mod_wave', els.fm_mod_wave.value);
        }

        function send(cmd, val) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(cmd + ":" + val);
            }
        }

        const bind = (id, cmd) => {
            const el = els[id];
            if (!el) {
                console.error("Missing element for bind:", id);
                return;
            }
            el.addEventListener('input', (e) => {
                const valEl = els[id + 'Val'];
                if (valEl) valEl.textContent = e.target.value;
                send(cmd, e.target.value);
            });
        };
        bind('drive', 'drive');
        bind('cutoff', 'cutoff');
        bind('res', 'res');
        bind('dtime', 'dtime');
        bind('dfeed', 'dfeed');
        bind('crate', 'chorus_rate');
        bind('cdepth', 'chorus_depth');
        bind('rtime', 'reverb_time');
        bind('rtone', 'reverb_tone');
        bind('amp', 'amp');
        bind('fm_ratio', 'fm_ratio');
        bind('fm_index', 'fm_index');
        bind('wt_index', 'wt_index');
        bind('logue_detune', 'logue_detune');
        bind('logue_oct', 'logue_oct');

        // Braids Binds
        bind('braids_model', 'braids_model');
        bind('braids_fine', 'braids_fine');
        bind('braids_coarse', 'braids_coarse');
        bind('braids_fm', 'braids_fm');
        bind('braids_timbre', 'braids_timbre');
        bind('braids_modulation', 'braids_modulation');
        bind('braids_color', 'braids_color');

        // Plaits Binds
        bind('plaits_model', 'plaits_model');
        bind('plaits_harmonics', 'plaits_harmonics');
        bind('plaits_timbre', 'plaits_timbre');
        bind('plaits_morph', 'plaits_morph');
        bind('plaits_decay', 'plaits_decay');
        bind('plaits_fm', 'plaits_fm');
        bind('plaits_fm', 'plaits_fm');
        bind('plaits_mod', 'plaits_mod');

        // Studio Binds
        bind('gmix', 'galactic_mix');
        bind('gsize', 'galactic_size');
        bind('gdetune', 'galactic_detune');
        bind('gbright', 'galactic_bright');
        bind('cdrive', 'console_drive');
        bind('tdrive', 'tope_drive');
        bind('tfuzz', 'tope_fuzz');

        let currentWave = 'sine';

        function updateVisibility() {
            const isFmWave = (currentWave === 'fm');
            const isCustomFm = els.fm_custom_on.checked;
            const isWt = (currentWave === 'wavetable');
            const isLogue = (currentWave === 'logue');
            const isBraids = (currentWave === 'braids');
            const isPlaits = (currentWave === 'plaits');

            if (isFmWave || isCustomFm) {
                els.fm_controls.classList.remove('hidden');
            } else {
                els.fm_controls.classList.add('hidden');
            }

            if (isWt) {
                els.wt_controls.classList.remove('hidden');
            } else {
                els.wt_controls.classList.add('hidden');
            }

            if (isLogue) {
                els.logue_controls.classList.remove('hidden');
            } else {
                els.logue_controls.classList.add('hidden');
            }

            if (isBraids) {
                els.braids_controls.classList.remove('hidden');
            } else {
                els.braids_controls.classList.add('hidden');
            }

            if (isPlaits) {
                els.plaits_controls.classList.remove('hidden');
            } else {
                els.plaits_controls.classList.add('hidden');
            }
        }

        window.setWave = (type, btn) => {
            document.querySelectorAll('#waveforms button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.classList.add('active');
            currentWave = type;
            updateVisibility();
            send('wave', type);
        };

        window.toggleCustomFM = (cb) => {
            els.fm_mod_wave.disabled = !cb.checked;
            updateVisibility();
            send('fm_enable', cb.checked ? 1 : 0);
        };

        window.setModWave = (sel) => {
            send('mod_wave', sel.value);
        };

        const toggleFx = (btnId, panelId, cmd) => {
            const btn = document.getElementById(btnId);
            const panel = document.getElementById(panelId);

            // Initial state check (for defaults)
            if (btn.classList.contains('active')) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }

            return () => {
                const isActive = btn.classList.toggle('active');
                if (isActive) panel.classList.remove('hidden');
                else panel.classList.add('hidden');
                send(cmd, isActive ? 1 : 0);
            };
        };

        // Helper to just send current state of buttons
        function updateFxState() {
            const isRev = document.getElementById('verbBtn').classList.contains('active');
            const isCho = document.getElementById('chorusBtn').classList.contains('active');
            const isDel = document.getElementById('delayBtn').classList.contains('active');
            send('reverb', isRev ? 1 : 0);
            send('chorus', isCho ? 1 : 0);
            send('delay', isDel ? 1 : 0);
        }

        window.toggleReverb = toggleFx('verbBtn', 'reverb_controls', 'reverb');
        window.toggleChorus = toggleFx('chorusBtn', 'chorus_controls', 'chorus');
        window.toggleDelay = toggleFx('delayBtn', 'delay_controls', 'delay');

        // --- KEYBOARD LOGIC ---
        // Standard "QWERTY Piano" mapping (Ableton/Logic style)
        // Base Note: C4 (MIDI 60)
        const keys = [
            { note: 60, key: 'a', type: 'white' }, // C4
            { note: 61, key: 'w', type: 'black' }, // C#4
            { note: 62, key: 's', type: 'white' }, // D4
            { note: 63, key: 'e', type: 'black' }, // D#4
            { note: 64, key: 'd', type: 'white' }, // E4
            { note: 65, key: 'f', type: 'white' }, // F4
            { note: 66, key: 't', type: 'black' }, // F#4
            { note: 67, key: 'g', type: 'white' }, // G4
            { note: 68, key: 'y', type: 'black' }, // G#4
            { note: 69, key: 'h', type: 'white' }, // A4
            { note: 70, key: 'u', type: 'black' }, // A#4
            { note: 71, key: 'j', type: 'white' }, // B4
            { note: 72, key: 'k', type: 'white' }, // C5
            { note: 73, key: 'o', type: 'black' }, // C#5
            { note: 74, key: 'l', type: 'white' }, // D5
            { note: 75, key: 'p', type: 'black' }, // D#5
            { note: 76, key: ';', type: 'white' }, // E5
            { note: 77, key: '\'', type: 'white' } // F5
        ];

        const kbEl = document.getElementById('kb');
        keys.forEach(k => {
            const div = document.createElement('div');
            div.className = `key ${k.type}`;
            div.id = `key-${k.key}`;
            div.innerHTML = `<span>${k.key.toUpperCase()}</span>`;

            // Mouse/Touch Events
            const down = (e) => { e.preventDefault(); playNote(k.note, div); };
            const up = (e) => { e.preventDefault(); stopNote(k.note, div); };

            div.addEventListener('mousedown', down);
            div.addEventListener('mouseup', up);
            div.addEventListener('mouseleave', up);
            div.addEventListener('touchstart', down);
            div.addEventListener('touchend', up);

            kbEl.appendChild(div);
        });

        let activeKey = null;

        function playNote(note, el) {
            if (activeKey === note) return; // Ignore repeats
            activeKey = note;
            if (el) el.classList.add('active');
            send('note', note);
            send('gate', 1);
        }

        function stopNote(note, el) {
            if (el) el.classList.remove('active');
            send('off', note); // Send NoteOff command
            // We still send gate=0 to decrement the active count on backend
            send('gate', 0);
            activeKey = null;
        }

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                playNote(k.note, document.getElementById(`key-${k.key}`));
            }
        });

        document.addEventListener('keyup', (e) => {
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                stopNote(k.note, document.getElementById(`key-${k.key}`));
            }
        });

        connect();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynthora FM</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ff9900;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            touch-action: none;
            user-select: none;
        }
        h1 { border-bottom: 2px solid #ff9900; padding-bottom: 0.5rem; margin-top: 0; }
        
        .panel {
            background: #222;
            border: 1px solid #444;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            display: grid;
            gap: 1.5rem;
        }
        
        .section-title {
            color: #888;
            font-size: 0.8rem;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .control { }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; }
        
        input[type=range] { width: 100%; accent-color: #ff9900; cursor: pointer; }
        
        .btn-group { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #666;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            flex: 1;
        }
        button.active {
            background: #ff9900;
            color: #000;
            border-color: #ff9900;
        }
        
        .fx-row { display: flex; gap: 10px; }
        
        /* KEYBOARD STYLES */
        .keyboard {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 10px;
            height: 120px;
        }
        .key {
            background: #fff;
            border-radius: 0 0 4px 4px;
            width: 40px;
            position: relative;
            cursor: pointer;
        }
        .key.black {
            background: #000;
            color: #fff;
            height: 70px;
            width: 30px;
            margin-left: -17px;
            margin-right: -17px;
            z-index: 2;
            border: 1px solid #333;
        }
        .key.white {
            height: 100%;
            z-index: 1;
            border: 1px solid #ccc;
        }
        .key.active {
            background: #ff9900 !important;
        }
        .key span {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            color: #888;
            font-size: 0.7rem;
            pointer-events: none;
        }
        
        #status {
            margin-top: 1rem;
            color: #666;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>ZYNTHORA FM</h1>
    
    <div class="panel">
        
        <!-- OSCILLATOR -->
        <div>
            <div class="section-title">SOURCE</div>
            <div class="control">
                <div class="btn-group" id="waveforms">
                    <button onclick="setWave('sine', this)" class="active">SIN</button>
                    <button onclick="setWave('triangle', this)">TRI</button>
                    <button onclick="setWave('saw', this)">SAW</button>
                    <button onclick="setWave('square', this)">SQR</button>
                    <button onclick="setWave('fm', this)">FM</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; border-top: 1px solid #333; padding-top: 10px;">
                <label style="margin:0;"><input type="checkbox" id="fm_custom_on" onchange="toggleCustomFM(this)"> CUSTOM FM</label>
                <select id="fm_mod_wave" onchange="setModWave(this)" disabled style="background:#333; color:#fff; border:1px solid #666; padding: 5px;">
                    <option value="0">SIN</option>
                    <option value="1">TRI</option>
                    <option value="2">SAW</option>
                    <option value="3">SQR</option>
                </select>
            </div>

            <div id="fm_controls" class="hidden" style="display: flex; gap: 10px; margin-top: 10px;">
                <div class="control" style="flex: 1;">
                    <label>FM RATIO: <span id="fm_ratioVal">2.0</span></label>
                    <input type="range" id="fm_ratio" min="0.1" max="10.0" value="2.0" step="0.1">
                </div>
                <div class="control" style="flex: 1;">
                    <label>FM INDEX: <span id="fm_indexVal">1.0</span></label>
                    <input type="range" id="fm_index" min="0.0" max="5.0" value="1.0" step="0.1">
                </div>
            </div>

            <div class="control" style="margin-top: 10px;">
                <label>DRIVE: <span id="driveVal">0.0</span></label>
                <input type="range" id="drive" min="0" max="1" value="0.0" step="0.01">
            </div>
        </div>

        <!-- FILTER -->
        <div>
            <div class="section-title">FILTER (MOOG)</div>
            <div class="control">
                <label>CUTOFF: <span id="cutoffVal">20000</span> Hz</label>
                <input type="range" id="cutoff" min="100" max="10000" value="20000" step="10">
            </div>
            <div class="control">
                <label>RESONANCE: <span id="resVal">0.0</span></label>
                <input type="range" id="res" min="0" max="0.95" value="0.0" step="0.01">
            </div>
        </div>

        <!-- EFFECTS -->
        <div>
            <div class="section-title">EFFECTS</div>
            <div class="fx-row">
                <button id="chorusBtn" onclick="toggleChorus()">CHORUS</button>
                <button id="delayBtn" onclick="toggleDelay()">DELAY</button>
                <button id="verbBtn" onclick="toggleReverb()">REVERB</button>
            </div>
            
            <!-- DELAY CONTROLS -->
            <div id="delay_controls" class="hidden" style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>DELAY TIME: <span id="dtimeVal">0.3</span>s</label>
                    <input type="range" id="dtime" min="0.05" max="0.9" value="0.3" step="0.01">
                </div>
                <div class="control">
                    <label>DELAY FEEDBACK: <span id="dfeedVal">0.4</span></label>
                    <input type="range" id="dfeed" min="0" max="0.9" value="0.4" step="0.01">
                </div>
            </div>

            <!-- CHORUS CONTROLS -->
            <div id="chorus_controls" class="hidden" style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>CHORUS RATE: <span id="crateVal">0.3</span>Hz</label>
                    <input type="range" id="crate" min="0.1" max="5.0" value="0.3" step="0.1">
                </div>
                <div class="control">
                    <label>CHORUS DEPTH: <span id="cdepthVal">0.8</span></label>
                    <input type="range" id="cdepth" min="0" max="1.0" value="0.8" step="0.01">
                </div>
            </div>

            <!-- REVERB CONTROLS -->
            <div id="reverb_controls" class="hidden" style="margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px;">
                <div class="control">
                    <label>REVERB DECAY: <span id="rtimeVal">0.85</span></label>
                    <input type="range" id="rtime" min="0.3" max="0.99" value="0.85" step="0.01">
                </div>
                <div class="control">
                    <label>REVERB TONE: <span id="rtoneVal">10000</span>Hz</label>
                    <input type="range" id="rtone" min="1000" max="18000" value="10000" step="100">
                </div>
            </div>
        </div>

        <!-- MASTER -->
        <div class="control" style="border-top: 1px solid #444; padding-top: 15px;">
            <label>MASTER VOL: <span id="ampVal">0.5</span></label>
            <input type="range" id="amp" min="0" max="1" value="0.5" step="0.01">
        </div>
        
        <!-- KEYBOARD -->
        <div>
            <div class="section-title">KEYBOARD (A-K = White Keys)</div>
            <div class="keyboard" id="kb">
                <!-- Generated by JS -->
            </div>
        </div>
        
        <div id="status">Connecting...</div>
    </div>

    <script>
        const els = {
            drive: document.getElementById('drive'),
            cutoff: document.getElementById('cutoff'),
            res: document.getElementById('res'),
            
            dtime: document.getElementById('dtime'),
            dfeed: document.getElementById('dfeed'),
            crate: document.getElementById('crate'),
            cdepth: document.getElementById('cdepth'),
            rtime: document.getElementById('rtime'),
            rtone: document.getElementById('rtone'),
            
            amp: document.getElementById('amp'),
            fm_ratio: document.getElementById('fm_ratio'),
            fm_index: document.getElementById('fm_index'),
            
            driveVal: document.getElementById('driveVal'),
            cutoffVal: document.getElementById('cutoffVal'),
            resVal: document.getElementById('resVal'),
            
            dtimeVal: document.getElementById('dtimeVal'),
            dfeedVal: document.getElementById('dfeedVal'),
            crateVal: document.getElementById('crateVal'),
            cdepthVal: document.getElementById('cdepthVal'),
            rtimeVal: document.getElementById('rtimeVal'),
            rtoneVal: document.getElementById('rtoneVal'),
            
            ampVal: document.getElementById('ampVal'),
            fm_ratioVal: document.getElementById('fm_ratioVal'),
            fm_indexVal: document.getElementById('fm_indexVal'),
            
            status: document.getElementById('status'),
            
            fm_controls: document.getElementById('fm_controls'),
            fm_custom_on: document.getElementById('fm_custom_on'),
            fm_mod_wave: document.getElementById('fm_mod_wave'),
            
            // FX Panels
            delay_controls: document.getElementById('delay_controls'),
            chorus_controls: document.getElementById('chorus_controls'),
            reverb_controls: document.getElementById('reverb_controls')
        };
        
        let socket;
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/websocket';
            socket = new WebSocket(wsUrl);
            socket.onopen = () => {
                els.status.textContent = "ONLINE";
                els.status.style.color = "#ff9900";
                syncState(); // Sync UI to DSP
            };
            socket.onclose = () => setTimeout(connect, 2000);
        }

        // Send all current UI values to the DSP
        function syncState() {
            console.log("Syncing state...");
            // Sliders
            send('drive', els.drive.value);
            send('cutoff', els.cutoff.value);
            send('res', els.res.value);
            
            send('dtime', els.dtime.value);
            send('dfeed', els.dfeed.value);
            send('chorus_rate', els.crate.value);
            send('chorus_depth', els.cdepth.value);
            send('reverb_time', els.rtime.value);
            send('reverb_tone', els.rtone.value);
            
            send('amp', els.amp.value);
            send('fm_ratio', els.fm_ratio.value);
            send('fm_index', els.fm_index.value);
            
            // Toggles
            updateFxState();
            
            // Waveform
            send('wave', currentWave);
            
            // Custom FM
            send('fm_enable', els.fm_custom_on.checked ? 1 : 0);
            send('mod_wave', els.fm_mod_wave.value);
        }

        function send(cmd, val) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(cmd + ":" + val);
            }
        }

        const bind = (id, cmd) => {
            const el = els[id];
            if (!el) {
                console.error("Missing element for bind:", id);
                return;
            }
            el.addEventListener('input', (e) => {
                const valEl = els[id + 'Val'];
                if (valEl) valEl.textContent = e.target.value;
                send(cmd, e.target.value);
            });
        };
        bind('drive', 'drive');
        bind('cutoff', 'cutoff');
        bind('res', 'res');
        bind('dtime', 'dtime');
        bind('dfeed', 'dfeed');
        bind('crate', 'chorus_rate');
        bind('cdepth', 'chorus_depth');
        bind('rtime', 'reverb_time');
        bind('rtone', 'reverb_tone');
        bind('amp', 'amp');
        bind('fm_ratio', 'fm_ratio');
        bind('fm_index', 'fm_index');

        let currentWave = 'sine';

        function updateFmVisibility() {
            const isFmWave = (currentWave === 'fm');
            const isCustomFm = els.fm_custom_on.checked;
            
            if (isFmWave || isCustomFm) {
                els.fm_controls.classList.remove('hidden');
            } else {
                els.fm_controls.classList.add('hidden');
            }
        }

        window.setWave = (type, btn) => {
            document.querySelectorAll('#waveforms button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentWave = type;
            updateFmVisibility();
            send('wave', type);
        };

        window.toggleCustomFM = (cb) => {
            els.fm_mod_wave.disabled = !cb.checked;
            updateFmVisibility();
            send('fm_enable', cb.checked ? 1 : 0);
        };

        window.setModWave = (sel) => {
            send('mod_wave', sel.value);
        };

        const toggleFx = (btnId, panelId, cmd) => {
            const btn = document.getElementById(btnId);
            const panel = document.getElementById(panelId);
            
            // Initial state check (for defaults)
            if (btn.classList.contains('active')) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }

            return () => {
                const isActive = btn.classList.toggle('active');
                if (isActive) panel.classList.remove('hidden');
                else panel.classList.add('hidden');
                send(cmd, isActive ? 1 : 0);
            };
        };
        
        // Helper to just send current state of buttons
        function updateFxState() {
             const isRev = document.getElementById('verbBtn').classList.contains('active');
             const isCho = document.getElementById('chorusBtn').classList.contains('active');
             const isDel = document.getElementById('delayBtn').classList.contains('active');
             send('reverb', isRev ? 1 : 0);
             send('chorus', isCho ? 1 : 0);
             send('delay', isDel ? 1 : 0);
        }

        window.toggleReverb = toggleFx('verbBtn', 'reverb_controls', 'reverb');
        window.toggleChorus = toggleFx('chorusBtn', 'chorus_controls', 'chorus');
        window.toggleDelay  = toggleFx('delayBtn', 'delay_controls', 'delay');

        // --- KEYBOARD LOGIC ---
        // Standard "QWERTY Piano" mapping (Ableton/Logic style)
        // Base Note: C4 (MIDI 60)
        const keys = [
            { note: 60, key: 'a', type: 'white' }, // C4
            { note: 61, key: 'w', type: 'black' }, // C#4
            { note: 62, key: 's', type: 'white' }, // D4
            { note: 63, key: 'e', type: 'black' }, // D#4
            { note: 64, key: 'd', type: 'white' }, // E4
            { note: 65, key: 'f', type: 'white' }, // F4
            { note: 66, key: 't', type: 'black' }, // F#4
            { note: 67, key: 'g', type: 'white' }, // G4
            { note: 68, key: 'y', type: 'black' }, // G#4
            { note: 69, key: 'h', type: 'white' }, // A4
            { note: 70, key: 'u', type: 'black' }, // A#4
            { note: 71, key: 'j', type: 'white' }, // B4
            { note: 72, key: 'k', type: 'white' }, // C5
            { note: 73, key: 'o', type: 'black' }, // C#5
            { note: 74, key: 'l', type: 'white' }, // D5
            { note: 75, key: 'p', type: 'black' }, // D#5
            { note: 76, key: ';', type: 'white' }, // E5
            { note: 77, key: '\'', type: 'white' } // F5
        ];

        const kbEl = document.getElementById('kb');
        keys.forEach(k => {
            const div = document.createElement('div');
            div.className = `key ${k.type}`;
            div.id = `key-${k.key}`;
            div.innerHTML = `<span>${k.key.toUpperCase()}</span>`;
            
            // Mouse/Touch Events
            const down = (e) => { e.preventDefault(); playNote(k.note, div); };
            const up = (e) => { e.preventDefault(); stopNote(div); };
            
            div.addEventListener('mousedown', down);
            div.addEventListener('mouseup', up);
            div.addEventListener('mouseleave', up);
            div.addEventListener('touchstart', down);
            div.addEventListener('touchend', up);
            
            kbEl.appendChild(div);
        });

        let activeKey = null;

        function playNote(note, el) {
            if (activeKey === note) return; // Ignore repeats
            activeKey = note;
            if(el) el.classList.add('active');
            send('note', note);
            send('gate', 1);
        }

        function stopNote(el) {
            if(el) el.classList.remove('active');
            send('gate', 0);
            activeKey = null;
        }

        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                playNote(k.note, document.getElementById(`key-${k.key}`));
            }
        });

        document.addEventListener('keyup', (e) => {
            const k = keys.find(x => x.key === e.key.toLowerCase());
            if (k) {
                stopNote(document.getElementById(`key-${k.key}`));
            }
        });

        connect();
    </script>
</body>
</html>
